# @ube-tsp/ky-client

A Ky-based HTTP client generator that transforms flat operation maps into nested type-safe client methods. Takes operation metadata from @ube-tsp/ky-emitter and creates intuitive client APIs with full TypeScript support.

## Features

- üåê **Type-Safe HTTP Client**: Full TypeScript support with generated operation types
- ‚ö° **Modern Fetch API**: Built on Ky, a lightweight HTTP client based on fetch
- üó∫Ô∏è **Operation Map Transformation**: Converts flat operation keys into nested client methods
- üîß **Flexible Configuration**: Customizable base URL and Ky options
- üìù **Request/Response Types**: Full type safety for parameters, body, and responses
- üèóÔ∏è **Dynamic Client Structure**: Automatically creates nested client objects from namespace structure

## Installation

```bash
npm install @ube-tsp/ky-client ky
```

## Usage

### Basic Client Generation

```typescript
import ky from 'ky';
import { createClient } from '@ube-tsp/ky-client';

// Import operation map generated by @ube-tsp/ky-emitter
const operationMap = {
  "PetStore.getPet": {
    operationId: "getPet",
    method: "GET",
    path: "/pet/{petId}",
    statusCodes: [200],
  },
  "PetStore.createPet": {
    operationId: "createPet",
    method: "POST", 
    path: "/pet",
    statusCodes: [201],
  },
  "UserService.getUser": {
    operationId: "getUser",
    method: "GET",
    path: "/user/{userId}",
    statusCodes: [200],
  }
} as const;

// Create Ky instance
const kyInstance = ky.create({ 
  prefixUrl: 'https://api.example.com',
  timeout: 10000,
  headers: {
    'Authorization': 'Bearer token123'
  }
});

// Create type-safe client (transforms flat keys into nested structure)
const client = createClient<YourClientType>(kyInstance, operationMap);

// Use nested client methods
const pet = await client.PetStore.getPet({ 
  params: { path: { petId: 123 } } 
});

const newPet = await client.PetStore.createPet({
  params: { body: { name: 'Fluffy', status: 'available' } }
});

const user = await client.UserService.getUser({
  params: { path: { userId: 456 } }
});
```

### Key Features

#### **Flat-to-Nested Transformation**

The client transforms flat operation map keys into nested client methods:

```typescript
// Operation map has flat keys:
const operationMap = {
  "PetStore.getPet": { /* operation details */ },
  "PetStore.createPet": { /* operation details */ },
  "UserService.getUser": { /* operation details */ },
  "UserService.Profile.updateProfile": { /* operation details */ },
};

// Client provides nested method access:
client.PetStore.getPet(...)
client.PetStore.createPet(...)
client.UserService.getUser(...)
client.UserService.Profile.updateProfile(...)
```

#### **Parameter Handling**

Automatically handles different parameter types:

```typescript
// Path parameters
await client.PetStore.getPet({
  params: { path: { petId: 123 } }
});

// Query parameters  
await client.PetStore.listPets({
  params: { query: { limit: 10, status: 'available' } }
});

// Request body
await client.PetStore.createPet({
  params: { body: { name: 'Fluffy', status: 'available' } }
});

// Headers
await client.PetStore.updatePet({
  params: { 
    path: { petId: 123 },
    header: { 'X-API-Key': 'secret' },
    body: { name: 'Updated Fluffy' }
  }
});
```

## API Reference

### `createClient<T>(kyInstance, operationMap)`

Creates a type-safe HTTP client from operation map.

**Parameters:**
- `kyInstance`: Configured Ky instance for making requests
- `operationMap`: Runtime operation map with flat keys and HTTP details

**Returns:** Nested client object with type-safe method calls

### Operation Map Structure

```typescript
type OperationMap = Record<string, {
  operationId: string;
  method: string;
  path: string; 
  statusCodes: number[];
}>;
```

## Integration with @ube-tsp/ky-emitter

This package is designed to work seamlessly with `@ube-tsp/ky-emitter`:

1. Use the emitter to generate TypeScript namespace files and operation map
2. Import the generated operation map
3. Create a type-safe client with full IntelliSense support

```typescript
// Generated by @ube-tsp/ky-emitter
import { operationMap } from './tsp-output/@ube-tsp/ky-emitter/operation-map.js';
import type { PetStoreClient } from './tsp-output/@ube-tsp/ky-emitter/Spec/PetStore.js';

// Create Ky instance
const kyInstance = ky.create({ 
  prefixUrl: process.env.API_BASE_URL 
});

// Create client with full type support
const client = createClient<PetStoreClient>(kyInstance, operationMap);
```

## Development

```bash
# Build the package
npm run build

# Run tests
npm run test

# Lint code
npm run lint
```

## License

MIT